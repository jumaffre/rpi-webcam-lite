<!DOCTYPE html>
<html>

<style>
    body { padding-top: 70px; }
</style>

<script src="https://apis.google.com/js/platform.js" async defer></script>

<meta name="google-signin-client_id" content="364019893582-usst6p90fq7fvgmutm46rjn0oa9it0uq.apps.googleusercontent.com">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

<script type="module" src="https://cdn.jsdelivr.net/npm/@slamb/multipart-stream@1.0.0/multipart-stream.js"> </script>

<title> Sanctoir </title>
<script>
    async function requestFeed(id_token) {
        // const response = await fetch(window.location.origin + "/static", {
        //     headers: {"authorization": "Bearer " + id_token}
        // });

        // // TODO: Only if not already created
        // if (response.status == 200) {
        //     let imgBlob = await response.blob()
        //     let imgURL = URL.createObjectURL(imgBlob);

        //     let img = document.createElement("img");
        //     img.src = imgURL;
        //     let imgElement = document.getElementById("img");
        //     imgElement.appendChild(img);
        // }

        const response = await fetch(window.location.origin + "/stream", {
            headers: {"authorization": "Bearer " + id_token}
        });

        let mod = await import("https://cdn.jsdelivr.net/npm/@slamb/multipart-stream@1.0.0/multipart-stream.js").then(async (module) => {
            console.log(module)
            console.log(response.headers.get("Content-Type"))
            const reader = module.default(response.headers.get('Content-Type'), response.body).getReader()
            
            let imgElement = document.getElementById("img");
            let img = document.createElement("img");
            imgElement.appendChild(img);
            
            let i = 0
            for (i = 0; i < 100; i++) {
                let {done, value} = await reader.read()
                if (done) {
                    break;
                }

                let imgURL = URL.createObjectURL(new Blob([value.body]));
                img.src = imgURL;
            }

        }).catch((error) => {console.log(error);})


        // lala()
        // while (true) {
        //     const {done, value} = reader.read();
        //     if (done) {
        //         break;
        //     }
        //     const {headers, body} = value;
        //     console.log(headers)

        // }

    }

    function onSignIn(googleUser) {
        console.log("Successfully signed in")
        var id_token = googleUser.getAuthResponse().id_token;
        requestFeed(id_token)
    }

</script>

<body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
        <a href="/" class="navbar-brand"> Home </a>

        <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        </div>

        <div class="g-signin2" data-onsuccess="onSignIn"></div>
    </nav>

    <div class="container">
        <div class="row">
            <div id="img" class="col-5">
                <img src=""/>
                <!-- Feed gets displayed here on successful authentication -->
            </div>
        </div>
    </div>
</body>
</html>
